<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on 天御实验室官方博客</title>
    <link>https://blog.tianyulab.com/post/feed/index.xml</link>
    <description>Recent content in Posts on 天御实验室官方博客</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <copyright>Copyright (c) 2018. All rights reserved.</copyright>
    <lastBuildDate>Wed, 14 Nov 2018 10:12:30 +0800</lastBuildDate>
    <atom:link href="https://blog.tianyulab.com/post/feed/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>威胁猎杀实战（二）：NIDS和HIDS关联</title>
      <link>https://blog.tianyulab.com/post/ty-practical-guide-to-threat-hunting-02/</link>
      <pubDate>Wed, 14 Nov 2018 10:12:30 +0800</pubDate>
      
      <guid>https://blog.tianyulab.com/post/ty-practical-guide-to-threat-hunting-02/</guid>
      <description>


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img01.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;pre&gt;&lt;code&gt;
防御终将失败!

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;1-我被黑了吗&#34;&gt;1.我被黑了吗？&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;继续之前，我们先尝试回答以下问题:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;有主机下载了EXE/ELF（可执行文件）？ &amp;ndash;&amp;gt; YES &amp;ndash;&amp;gt; 木马？嗯哼？&lt;/li&gt;
&lt;li&gt;下载的EXE/ELF运行了吗？&lt;/li&gt;
&lt;li&gt;电脑被黑了？？&lt;/li&gt;
&lt;li&gt;Beaconing？？？&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;2-hids-rootkit-em-有点意思&#34;&gt;2.HIDS &amp;ndash;&amp;gt; Rootkit？em&amp;hellip;有点意思&lt;/h3&gt;

&lt;p&gt;对于高级Rootkit等攻击技术，单纯的HIDS or EDR能解决问题？&lt;/p&gt;

&lt;p&gt;行业角度：主机层面的威胁感知已经从传统的HIDS发展为主机自适应安全（Gartern）&lt;/p&gt;

&lt;p&gt;技术角度：目前主流的实现有：Wazuh、osquery、perf/eBPF、Grsecurity/PaX等，不一一罗列&lt;/p&gt;

&lt;h3 id=&#34;3-nids-加密流量-呵呵呵&#34;&gt;3.NIDS &amp;ndash;&amp;gt; 加密流量。。。呵呵呵&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;    迅猛增长的加密流量正不断改变着威胁形势。随着越来越多的企业实现全数字化,大量的服务和应用都采用加密技术作为确保信息安全的首要方法。更具体地说,加密流量同比增长已超过 90%,对流量进行加密的网站数量已从 2015 年的 21% 上升到 2016 年的超过 40%。据 Gartner 预测,到2019 年,80% 的网站流量都会被加密。
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;​    遗憾的是目前主流的NIDS无法直接对加密流量进行检测。当然对于加密流量也不是没有办法，这里先透露一下，后续我们会有专门的文章进行探讨。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# 应对加密流量的几种方式：

1.ssl proxy 硬件/软件
2.IDS放在负载均衡器后面
3.JA3（salesforce）
4.Cisco Encrypted Traffic Analytics（含机器学习）
5.NIDS + HIDS 关联

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;4-nids进化-nsm网络安全监控&#34;&gt;4.NIDS进化 &amp;ndash;&amp;gt; NSM网络安全监控&lt;/h3&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img02.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;strong&gt;做入侵检测的朋友们应该非常熟悉这样的Alert（警报），是不是有些抓狂。。。，从警报上我们只能知道主机：192.168.8.11&lt;/strong&gt;可能&lt;strong&gt;从外部主机：183.47.221.72下载了PE EXE可执行文件，无法确认是否误报也无法确认该文件是否是木马程序。&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;--&amp;gt; 进入NSM（网络安全监控）
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-nsm-看起来真有问题啊-谁干的&#34;&gt;5.NSM &amp;ndash;&amp;gt; 看起来真有问题啊，谁干的？？？&lt;/h3&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img03.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;我们再来看看这个图（NSM网络安全监控系统）&lt;/p&gt;

&lt;p&gt;图中有几个关键信息：&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;➀.系统检测到主机下载了可执行文件&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;➁.查看对应的入侵检测规则和Payload数据&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;➂.查看会话数据（Bro）及全包捕捉数据&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;➃.通过与VT和Cuckoo或其他沙盒关联，至此我们可以检测90%的可疑程序，但是无法100%检测（无法拿到主机数据）&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;--&amp;gt; 进入威胁感知平台
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;6-威胁感知平台-顺应时代而生-看我揭开你神秘的面纱&#34;&gt;6.威胁感知平台 &amp;ndash;&amp;gt; 顺应时代而生？） &amp;ndash;&amp;gt; 看我揭开你神秘的面纱&lt;/h3&gt;

&lt;p&gt;
&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-01-img01.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;

&lt;table class=&#34;image&#34;&gt;
&lt;caption align=&#34;bottom&#34;&gt; 天御威胁感知平台® &lt;/caption&gt;
&lt;/table&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;
警告：威胁感知并非态势感知！

&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;6-1-网络层和主机层关联原理与实现&#34;&gt;6.1 网络层和主机层关联原理与实现&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;    网络层和主机层关联有多种实现方式，我们今天主要介绍Bro + osquery的方式，我们会在后续的文章中介绍其他方式。
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;6-1-1-技术栈-bro-osquery&#34;&gt;6.1.1 技术栈：Bro + osquery&lt;/h5&gt;

&lt;h6 id=&#34;6-1-1-1-bro-network-security-monitor简介&#34;&gt;6.1.1.1 Bro Network Security Monitor简介&lt;/h6&gt;

&lt;pre&gt;&lt;code&gt;这里直接引用Bro团队官方的解释：
a) It transforms raw network traffic into detailed network logs, organized by protocol
# 这也是Bro的迷人之处，内部拥有无穷无尽的Data

b) It’s a programmable platform that can be used to automate traffic analysis tasks via
scripts.
&lt;/code&gt;&lt;/pre&gt;

&lt;h6 id=&#34;6-1-1-2-osquery简介&#34;&gt;6.1.1.2 osquery简介&lt;/h6&gt;

&lt;pre&gt;&lt;code&gt;一句话，osquery正在成为新的HIDS标准。（github上超过1w星，很多安全初创企业也是基于osquery，如Uptycs，Kolide）
&lt;/code&gt;&lt;/pre&gt;

&lt;h6 id=&#34;6-1-1-3-关联原理与实现&#34;&gt;6.1.1.3 关联原理与实现&lt;/h6&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img04.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;pre&gt;&lt;code&gt;1.架构图

主要分为两部分组成：
a) Bro Controller（Bro + osquery Framwork（Bro脚本））
b) osquery Sensor（osquery + plugin）
c) Bro Controller和osquery Sensor使用Broker进行数据交换
&lt;/code&gt;&lt;/pre&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img05.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;pre&gt;&lt;code&gt;2.进程和Socket关联，主机和网络关联

a) 进程和Socket关联：基于Linux内核audit，使用osquery的process_events和socket_events表进行关联
b) 主机和网络关联：取socket_events表中的五元组数据和Bro Controller conn.log五元组数据进行关联
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;6-2-实战&#34;&gt;6.2 实战&lt;/h4&gt;

&lt;h5 id=&#34;6-2-1-可见-感知-猎杀&#34;&gt;6.2.1 可见、感知 &amp;ndash;&amp;gt; 猎杀&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;这个功能你会喜欢，Right？

1.在网络层看到的流量可以定位到由哪台主机、哪个用户、哪个进程发起的网络连接。
2.网络层拥有主机层完整的资产信息（系统、进程、网络连接等），同时可以实时查询主机层的资产信息。
&lt;/code&gt;&lt;/pre&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img06.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;



&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-02-img07.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h5 id=&#34;6-2-2-部署脚本-啥也别说了-让我们干起了&#34;&gt;6.2.2 部署脚本（啥也别说了，让我们干起了！）&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;# 注意：本项目仍处于开发阶段！

# 1.Bro Controller
## 1.1 安装Bro(git版)和osquery Framwork

#!/bin/bash

set -e
# Any subsequent(*) commands which fail will cause the shell script to exit immediately
# 如果sha256sum检查失败，脚本退出

# 记录脚本行为（排错目的），sh -x $0
exec 3&amp;gt;&amp;amp;1 4&amp;gt;&amp;amp;2
trap &#39;exec 2&amp;gt;&amp;amp;4 1&amp;gt;&amp;amp;3&#39; 0 1 2 3
exec 1&amp;gt;log.out 2&amp;gt;&amp;amp;1

# Ubuntu 16.04

# 安装依赖软件包
apt-get -y install cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev

# 1.Install Bro From Git Source
git clone --recursive git://git.bro.org/bro
cd bro
./configure --prefix=/opt/bro --enable-debug
make &amp;amp;&amp;amp; sudo make install

# 2.Install osquery Framwork
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/tianyulab.osquery.tar.gz
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/tianyulab.osquery.tar.gz.sha256sum
sha256sum -c tianyulab.osquery.tar.gz.sha256sum
tar xf tianyulab.osquery.tar.gz
cp -a osquery /opt/bro/share/bro/site/

# 3.Run Bro
echo &amp;quot;@load osquery&amp;quot; &amp;gt;&amp;gt; /opt/bro/share/bro/site/local.bro
/opt/bro/bin/broctl deploy

# 4.验证
/opt/bro/bin/broctl status
netstat -tupnl | grep 9999

########################################################################################

# 2.安装osquery Sensor（定制版Osquery）

#!/bin/bash
set -e
# Any subsequent(*) commands which fail will cause the shell script to exit immediately
# 如果sha256sum检查失败，脚本退出

# 运行:sh -x $0 &amp;quot;Bro IP&amp;quot;

# 记录脚本行为（排错目的）
exec 3&amp;gt;&amp;amp;1 4&amp;gt;&amp;amp;2
trap &#39;exec 2&amp;gt;&amp;amp;4 1&amp;gt;&amp;amp;3&#39; 0 1 2 3
exec 1&amp;gt;log.out 2&amp;gt;&amp;amp;1

# Ubuntu 16.04

# 1.安装依赖软件包
sudo apt update &amp;amp;&amp;amp; sudo apt-get -y install sudo make python ruby git bash curl python-pip

# 2.安装osquery Sensor
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/osquery_sensor.deb
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/osquery_sensor.deb.sha256sum
sha256sum -c osquery_sensor.deb.sha256sum
dpkg -i osquery_sensor.deb
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/osquery.bro.example.conf -O /etc/osquery/osquery.conf

# 3.配置&amp;amp;启动
# export bro_ip=`ip route get 1 | awk &#39;{print $NF;exit}&#39;` # 替换为：Bro IP
export bro_ip=&amp;quot;$1&amp;quot;
sudo sed -i -e &#39;/&amp;quot;bro_ip&amp;quot;:/s/.*/&amp;quot;bro_ip&amp;quot;: &amp;quot;&#39;&amp;quot;$bro_ip&amp;quot;&#39;&amp;quot;,/&#39; /etc/osquery/osquery.conf

sudo osqueryctl config-check
# sudo osqueryctl start
# /usr/bin/osqueryd --config_path=/etc/osquery/osquery.conf --pidfile=/var/run/osqueryd.pidfile

# systemd
sudo systemctl enable osqueryd
sudo systemctl start osqueryd

########################################################################################

# 3.配置ELK（可选项）
使用Filebeat传送日志，logstash接收
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/bro-osquery_logstash.conf
cp bro-osquery_logstash.conf /etc/logstash/conf.d/

wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro_osquery/bro_osq_filebeat.yml
cp bro_osq_filebeat.yml /etc/filebeat/filebeat.yml

# 启动顺序：logstash，filebeat
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;7-排错与调试&#34;&gt;7.排错与调试&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;# 1.Bro
bro -B help
/opt/bro-2.6/bin/bro -i enp3s0 -U .status  -p standalone -p local -p bro local.bro -B broker --filter &amp;quot;src host 192.168.8.112&amp;quot; &amp;quot;Site::local_nets += { 192.168.8.0/24 }&amp;quot;

# 2.osquery
osqueryd --disable-distributed=false --distributed_interval=0 --distributed_plugin bro --bro-ip=&amp;quot;192.168.8.3&amp;quot; --logger_plugin bro --log_result_events=0 --disable_audit=0 --audit_allow_config=1 --audit_allow_sockets=1 --verbose --audit_debug

https://github.com/facebook/osquery/blob/master/docs/wiki/deployment/process-auditing.md#troubleshooting-auditing-on-linux

# 3.audit
auditctl -l # lists all currently loaded Audit rules
auditctl -s # reports the status of the Audit system
auditd -f # leave the audit daemon in the foreground for debugging

## 参考：
Linux System call list
https://jlk.fjfi.cvut.cz/arch/manpages/man/syscalls.2
https://jlk.fjfi.cvut.cz/arch/manpages/man/socketcall.2.en
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;8-注意事项&#34;&gt;8.注意事项&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;# 1.流量镜像
需要把osquery Sensor的流量镜像到Bro Contrller，通过TAP，交换机或主机层面流量copy工具

iptables -t mangle -A PREROUTING -s 9.9.9.9/32 -j TEE --gateway 192.168.8.2
iptables -t mangle -A POSTROUTING -d 9.9.9.9/32 -j TEE --gateway 192.168.8.2

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;9-视频demo-show-time-吼吼&#34;&gt;9.视频Demo（show time 吼吼）&lt;/h3&gt;

&lt;p&gt;&lt;embed src=&#39;http://player.youku.com/player.php/sid/XMzgzODY5MzI5Ng==/v.swf&#39; allowFullScreen=&#39;true&#39; quality=&#39;high&#39; width=&#39;480&#39; height=&#39;400&#39; align=&#39;middle&#39; allowScriptAccess=&#39;always&#39; type=&#39;application/x-shockwave-flash&#39;&gt;&lt;/embed&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;超清版：&lt;/strong&gt;&lt;br /&gt;
&lt;a href=&#34;https://github.com/tianyulab/Video_Demo/blob/master/Bro_osquery_Demo_01.mp4&#34;&gt;&lt;strong&gt;威胁猎杀实战（二）：NIDS和HIDS关联 视频演示&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;10-致谢&#34;&gt;10.致谢&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;
1.此项目原由Steffen Haas开发，国内团队如果感兴趣可直接联系Hass（Email：haas@informatik.uni-hamburg.de）
2.@Bro团队
3.特别感谢Steffen Haas提供的思路和帮助！

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>威胁猎杀实战（一）：平台</title>
      <link>https://blog.tianyulab.com/post/ty-practical-guide-to-threat-hunting-01/</link>
      <pubDate>Tue, 13 Nov 2018 11:41:44 +0800</pubDate>
      
      <guid>https://blog.tianyulab.com/post/ty-practical-guide-to-threat-hunting-01/</guid>
      <description>

&lt;pre&gt;&lt;code&gt; ​    在国内Threat Hunting常被翻译成威胁追踪或威胁狩猎，我们认为：“未知攻焉知防，未知防焉知攻”。蓝方并不一定要处于被动防守的状态，完全可以主动猎杀对手！

 ​    本文是威胁猎杀实战系列的第一篇，按照本文的操作步骤，只需几次Copy&amp;amp;Paste即可搭建一套基于Elastic Stack的威胁猎杀平台。在后面的文章我们会进一步完善我们的平台。
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;
&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-01-img01.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;

&lt;table class=&#34;image&#34;&gt;
&lt;caption align=&#34;bottom&#34;&gt; 天御威胁感知平台® &lt;/caption&gt;
&lt;/table&gt;&lt;/p&gt;

&lt;p&gt;
&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-01-img02.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;

&lt;table class=&#34;image&#34;&gt;
&lt;caption align=&#34;bottom&#34;&gt; NSM架构 &lt;/caption&gt;
&lt;/table&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-部署elastic-stack-容器化&#34;&gt;1.部署Elastic Stack（容器化）&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ echo &amp;quot;nameserver 9.9.9.9&amp;quot; &amp;gt; /etc/resolv.conf
$ git clone https://github.com/Zer0d0y/docker-elk.git
$ docker-compose build &amp;amp;&amp;amp; docker-compose up -d

访问Kibana web UI：http://localhost:5601

完整指南参考：
https://github.com/Zer0d0y/docker-elk
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-部署bro&#34;&gt;2.部署Bro&lt;/h3&gt;

&lt;h4 id=&#34;2-1-安装&#34;&gt;2.1 安装&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;方式一：使用官方提供的Binary软件包&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Ubuntu 16.04：
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Install_Bro_from_binary.sh
$ chmod +x Install_Bro_from_binary.sh &amp;amp;&amp;amp; ./Install_Bro_from_binary.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Bro repository提供5个Binary软件包：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Bro，包含meta-package&lt;/li&gt;
&lt;li&gt;bro-core，包含Bro core和scripts&lt;/li&gt;
&lt;li&gt;broctl，包含Bro control&lt;/li&gt;
&lt;li&gt;libbroccoli和libbroccoli-dev，包含libbroccoli及其开发头文件&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code&gt;Ubuntu 16.04：
$ wget -nv http://download.opensuse.org/repositories/network:bro/xUbuntu_16.04/Release.key -O Release.key
$ sudo apt-key add - &amp;lt; Release.key
$ sudo apt-get update
$ sudo sh -c &amp;quot;echo &#39;deb http://download.opensuse.org/repositories/network:/bro/xUbuntu_16.04/ /&#39; &amp;gt; /etc/apt/sources.list.d/bro.list&amp;quot;
$ sudo apt-get update
$ sudo apt-get install bro

# 注意：官方同时提供nightly binary builds：https://www.bro.org/download/nightly-packages.html
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;方式二：源码安装&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;依赖软件包：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;其他依赖软件包（可选）：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;参考：https://www.bro.org/sphinx/install/install.html#id6
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;Ubuntu 16.04：
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Install_Bro_from_source.sh
$ chmod +x Install_Bro_from_source.sh &amp;amp;&amp;amp; ./Install_Bro_from_source.sh

# 注意：也可以安装Bro开发版：https://www.bro.org/sphinx/install/install.html#id9
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;方式三：容器化方式（Docker）&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;参考：
https://github.com/bro/bro-docker
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;2-2-配置&#34;&gt;2.2 配置&lt;/h4&gt;

&lt;h5 id=&#34;2-2-1-bro配置文件&#34;&gt;2.2.1 Bro配置文件&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;$PREFIX == 默认值：/opt/bro或/usr/local/bro

配置监听网络接口：$PREFIX/etc/node.cfg
配置本地网络地址：$PREFIX/etc/networks.cfg
主配置文件：$PREFIX/etc/broctl.cfg

# 完整配置参考：https://www.zer0d0y.info/post/Bro-plus-ELK/
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;2-2-2-使用systemd管理bro&#34;&gt;2.2.2 使用systemd管理Bro&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;# 修改Bro接口名称
$ INAME=$(ip -o link show | sed -rn &#39;/^[0-9]+: en/{s/.: ([^:]*):.*/\1/p}&#39;)
$ sed -i &amp;quot;s/eth0/$INAME/g&amp;quot; /usr/local/bro/etc/node.cfg
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Bro_systemd.service -O /etc/systemd/system/bro.service
$ systemctl daemon-reload   
$ systemctl enable bro  
$ systemctl start bro   
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-整合elastic-stack-kafka-和bro&#34;&gt;3.整合Elastic Stack，[Kafka]和Bro&lt;/h3&gt;

&lt;h4 id=&#34;3-1-bro日志101&#34;&gt;3.1 Bro日志101&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;conn.log -- IP, TCP, UDP, ICMP
dhcp.log -- DHCP
dns.log -- DNS查询/响应
ftp.log -- FTP请求/响应
http.log -- HTTP请求/响应
files.log -- 文件还原
mysql.log -- MySQL
irc.log -- IRC
radius.log -- RADIUS认证
kerberos.log -- Kerberos认证
sip.log -- SIP协议
smtp.log -- SMTP事务
ssl.log -- SSL握手
ssh.log -- SSH握手
syslog.log -- Syslog消息
tunnel.log -- 封装隧道的细节

Microsoft相关的日志
dce_rpc.log -- DCE/RPC消息
ntlm.log -- NTLM
rdp.log -- 远程桌面 (RDP)
smb_files.log -- SMB文件传输
smb_mapping.log -- SMB管道

# 详细解释：https://github.com/corelight/bro-cheatsheets
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;3-2-使用elastic-stack直接处理bro的csv格式日志&#34;&gt;3.2 使用Elastic Stack直接处理Bro的csv格式日志&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;# 注意事项
1.端口开放（--&amp;gt; 防火墙）：
    elasticsearch:9200
    Logstash:5044
    Kibana:5061
2.&amp;quot;index =&amp;gt; &amp;quot;bro_logs-%{+YYYY.MM.dd}&amp;quot;&amp;quot;,其中index名称必须小写
3.创建Index Patterns前必须有对应Bro的日志，否则会导致Field不全

# 软件环境
Elastic Stack 6.4
bro version 2.5.4

# 方式一：使用Filebeat处理Bro日志，
数据流：
Bro --&amp;gt; Filebeat --&amp;gt; ELK(Logstash)

1.安装Filebeat

Ubuntu 16.04：
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Install_Filebeat.sh
$ chmod +x Install_Filebeat.sh &amp;amp;&amp;amp; ./Install_Filebeat.sh

2.配置ELK(Logstash)接收来自FileBeat收集的Bro日志
# 注意：此命令在ELK主机上执行
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Deploy_Bro_Filebeat_Logstash.sh
$ chmod +x Deploy_Bro_Filebeat_Logstash.sh &amp;amp;&amp;amp; ./Deploy_Bro_Filebeat_Logstash.sh
$ sed -i &#39;s/8.8.8.8/ELK IP/g&#39; Bro_Filebeat_Logstash.conf
$ systemctl start logstash.service

3.配置Filebeat处理Bro日志
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Deploy_Filebeat.sh
$ chmod +x Deploy_Filebeat.sh &amp;amp;&amp;amp; ./Deploy_Filebeat.sh
$ sed -i &#39;s/8.8.8.8/ELK logstash IP/g&#39; /etc/filebeat/filebeat.yml
$ service filebeat start

4.访问Kibana web UI：http://localhost:5601，添加&amp;quot;Index Patterns&amp;quot;
正常情况下，字段(Fields) &amp;gt;= 218

# 方式二：使用Logstash处理Bro日志，
数据流：
Bro --&amp;gt; Logstash --&amp;gt; ELK(Elasticsearch)

1.安装Logstash

Ubuntu 16.04：
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Install_Logstash.sh
$ chmod +x Install_Logstash.sh &amp;amp;&amp;amp; ./Install_Logstash.sh

2.配置Logstash处理Bro日志

# 注意：如ELK和Bro不在同一台服务器上，需要修改配置文件中elasticsearch的值，如： hosts =&amp;gt; [&amp;quot;ELK IP:9200&amp;quot;]
# sed -i &#39;s/localhost/ELK IP/g&#39; bro*.conf

$ cd /etc/logstash/conf.d
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Deploy_Logstash.sh
$ chmod +x Deploy_Logstash.sh &amp;amp;&amp;amp; ./Deploy_Logstash.sh
$ rm -f Deploy_Logstash.sh

3.访问Kibana web UI：http://localhost:5601，添加“Index Patterns”

# 调试&amp;amp;排错
## Logstash
$ mkdir -p /root/xxx/logs &amp;amp;&amp;amp; cd /root/xxx
$ /usr/share/logstash/bin/logstash -f xxx.conf --path.logs /root/xxx/logs --log.level=debug --config.debug --config.test_and_exit                                                                                   
$ /usr/share/logstash/bin/logstash -f nmap-logstash.conf --path.logs /root/xxx/logs/ --log.level=debug --config.debug 2&amp;gt;&amp;amp;1 | tee /root/xxx/logs/101
## FileBeat
$ filebeat -e -d &amp;quot;*&amp;quot; -c /etc/filebeat/filebeat.yml

# 容器化ELK项目对应配置（https://github.com/Zer0d0y/docker-elk）
1.docker-elk/docker-compose.yml
  logstash:
    ports:
      - &amp;quot;5044:5044&amp;quot;
2.docker-elk/logstash/pipeline/bro_logs.conf
3.docker-compose build
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;3-3-使用elastic-stack-kafka处理bro的json格式日志&#34;&gt;3.3 使用Elastic Stack + Kafka处理Bro的json格式日志&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;数据流：
Bro --&amp;gt; Kafka --&amp;gt; Logstash --&amp;gt; ELK(Elasticsearch)
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;3-3-1-安装kafka&#34;&gt;3.3.1 安装Kafka&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;# 软件环境：
# Ubuntu 16.04
# Elastic Stack 6.4
# Bro 2.5.5
# Kafka 2.12
# librdkafka-0.9.4

# 1.安装Kafka
# 创建临时目录
mkdir /src &amp;amp;&amp;amp; cd /src

# 下载&amp;amp;验证kafka
wget https://archive.apache.org/dist/kafka/1.0.0/kafka_2.12-1.0.0.tgz
wget https://archive.apache.org/dist/kafka/1.0.0/kafka_2.12-1.0.0.tgz.asc
gpg --recv-keys  3B417B9B 
gpg -v kafka_2.12-1.0.0.tgz.asc

# 安装&amp;amp;启动kafka服务
tar -xf kafka_2.12-1.0.0.tgz
sudo mv kafka_2.12-1.0.0 /opt/kafka
sudo sed -i &#39;/^log.dirs/{s/=.*//;}&#39; /opt/kafka/config/server.properties
sudo sed -i &#39;s/^log.dirs/log.dirs=\/var\/lib\/kafka/&#39; /opt/kafka/config/server.properties
sudo sed -i &#39;$alisteners=bro://BRO所在机器的IP地址:9092&#39; /opt/kafka/config/server.properties 

cat &amp;gt; /etc/systemd/system/kafka.service &amp;lt;&amp;lt; EOF
[Unit]
Description=Kafka Service
Wants=network.target
After=zookeeper.target

[Service]
ExecStart=/opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties
ExecReload=on-failure
Restart=always
User=root
Group=root
StandardOutput=syslog
StandardError=syslog

[Install]
WantedBy=multi-user.target
EOF

# 
sudo apt-get -y install zookeeperd
sudo systemctl enable zookeeper 
sudo systemctl start zookeeper
sudo systemctl daemon-reload
sudo systemctl enable kafka 
sudo systemctl start kafka
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;3-3-2-安装kafka插件-metron-bro-plugin-kafka&#34;&gt;3.3.2 安装kafka插件（metron-bro-plugin-kafka）&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;# 更新
bro-pkg install apache/metron-bro-plugin-kafka
http://mailman.icsi.berkeley.edu/pipermail/bro/2018-October/013654.html

## 安装librdkafka
curl -L https://github.com/edenhill/librdkafka/archive/v0.9.4.tar.gz | tar xvz 
cd librdkafka-0.9.4/ 
./configure --enable-sasl 
make 
sudo make install 
## 构建插件
### 先安装Bro 2.5.5
cd /src
wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Install_Bro_from_source.sh
chmod +x Install_Bro_from_source.sh &amp;amp;&amp;amp; ./Install_Bro_from_source.sh

git clone https://github.com/apache/metron-bro-plugin-kafka.git
cd metron-bro-plugin-kafka
./configure --bro-dist=/src/bro-2.5.5/
make 
sudo make install
## 验证
/usr/local/bro/bin/bro -N Apache::Kafka

&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;3-3-3-配置bro把日志发送到kafka&#34;&gt;3.3.3 配置Bro把日志发送到Kafka&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;$ vi /usr/local/bro/share/bro/site/local.bro

@load /usr/local/bro/lib/bro/plugins/APACHE_KAFKA/scripts/Apache/Kafka/logs-to-kafka.bro
redef Kafka::topic_name = &amp;quot;&amp;quot;;
redef Kafka::logs_to_send = set(Conn::LOG, HTTP::LOG, DNS::LOG, SMTP::LOG, SSL::LOG, Software::LOG, DHCP::LOG, FTP::LOG, IRC::LOG, Notice::LOG, X509::LOG, SSH::LOG, SNMP::LOG);
redef Kafka::kafka_conf = table([&amp;quot;metadata.broker.list&amp;quot;] = &amp;quot;BRO所在机器的IP地址:9092&amp;quot;);
redef Kafka::tag_json = T;
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;3-3-4-配置logstash接收kafka日志&#34;&gt;3.3.4 配置Logstash接收Kafka日志&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;## 先安装Logstash
$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Install_Logstash.sh
$ chmod +x Install_Logstash.sh &amp;amp;&amp;amp; ./Install_Logstash.sh
$ echo config.reload.automatic: true |sudo tee -a /etc/logstash/logstash.yml
$ echo config.reload.interval: 3s |sudo tee -a /etc/logstash/logstash.yml
# 以Bro conn日志为例：
$ cat &amp;gt; /etc/logstash/conf.d/bro-conn.conf &amp;lt;&amp;lt; EOF
input {
	kafka {
		topics =&amp;gt; [&amp;quot;conn&amp;quot;]
		group_id =&amp;gt; &amp;quot;bro_logstash&amp;quot;
     		bootstrap_servers =&amp;gt; &amp;quot;10.42.94.92:9092&amp;quot;
     		codec =&amp;gt; json
     		type =&amp;gt; &amp;quot;conn&amp;quot;
     		auto_offset_reset =&amp;gt; &amp;quot;earliest&amp;quot;
	}
}

output {
	if [type] == &amp;quot;conn&amp;quot; {
		elasticsearch {
			hosts =&amp;gt; [&amp;quot;192.168.8.112:9200&amp;quot;]
			index =&amp;gt; &amp;quot;bro-conn-%{+YYYY.MM.dd}&amp;quot;
		}
	}
}
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;3-3-5-一键部署脚本&#34;&gt;3.3.5 一键部署脚本&lt;/h5&gt;

&lt;pre&gt;&lt;code&gt;$ wget https://github.com/tianyulab/Threat_Hunting_with_ELK/raw/master/Bro/Deploy_Kafka_for_Bro.sh
# 修改10.42.94.92 --&amp;gt; 为Kafka监听IP
$ sed -i &#39;s/10.42.94.92/Kafka监听IP/g&#39; Deploy_Kafka_for_Bro.sh
# 修改192.168.8.112 --&amp;gt; 为Elasticsearch监听IP
$ sed -i &#39;s/192.168.8.112/Elasticsearch监听IP/g&#39; Deploy_Kafka_for_Bro.sh
# 修改&amp;quot;BRO所在机器的IP地址&amp;quot;为BRO所在机器的IP地址
$ sed -i &#39;s/BRO所在机器的IP地址/BRO所在机器的IP地址/g&#39; Deploy_Kafka_for_Bro.sh
$ sh -x Deploy_Kafka_for_Bro.sh

# 验证
$ sudo systemctl status zookeeper
$ sudo systemctl status kafka
$ systemctl status logstash
$ /usr/local/bro/bin/bro -N Apache::Kafka
$ /usr/local/bro/bin/broctl status
$ netstat -tunlp  | grep -E &#39;2181|9092|9600&#39;

# 安装过程排错
$ watch tail log.out
$ cat log.out | grep error
$ cat log.out | grep -B 10 &amp;quot;Configuring incomplete, errors occurred&amp;quot;
$ cat log.out | grep -i &amp;quot;cd librdkafka-0.9.4&amp;quot; -A 50 | more

# Kafka 排错
$ apt-get install kafkacat
$ kafkacat -b 192.168.8.115:9092 -t http -o end # &amp;quot;http&amp;quot;为Bro的kafka插件定义的&amp;quot;topics&amp;quot;
或
$ /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server 192.168.8.115:9092 --topic http

# Kibana 创建index
bro-conn-*
bro-dns-*
... ...
然后创建
bro-*
&lt;/code&gt;&lt;/pre&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/ty-practical-guide-to-threat-hunting-01-img03.jpeg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;strong&gt;致谢：&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;@HardenedLinux 团队&lt;/p&gt;

&lt;p&gt;@Rock NSM团队&lt;/p&gt;

&lt;p&gt;@Security Onion团队&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s?__biz=MzU0MzgyMzM2Nw==&amp;amp;mid=2247483724&amp;amp;idx=1&amp;amp;sn=40ca6e7c577f0bbac2cc6424ee61ce00&amp;amp;chksm=fb04c224cc734b32a1d3ed27209a8a279159ca46fb51575dda1828f00c391f3b58920b581c50&amp;amp;scene=0#rd 微信公众号链接&#34;&gt;&lt;strong&gt;微信公众号：威胁猎杀实战（一）：平台&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>